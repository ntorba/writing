<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Build a Seldon-core Microservice | Turbo</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Build a Seldon-core Microservice" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Get an ML endpoint up and running!" />
<meta property="og:description" content="Get an ML endpoint up and running!" />
<link rel="canonical" href="https://ntorba.github.io/writing/seldon-core/docker/2020/07/30/first-seldon-core-microservice.html" />
<meta property="og:url" content="https://ntorba.github.io/writing/seldon-core/docker/2020/07/30/first-seldon-core-microservice.html" />
<meta property="og:site_name" content="Turbo" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-30T00:00:00-05:00" />
<script type="application/ld+json">
{"dateModified":"2020-07-30T00:00:00-05:00","description":"Get an ML endpoint up and running!","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ntorba.github.io/writing/seldon-core/docker/2020/07/30/first-seldon-core-microservice.html"},"url":"https://ntorba.github.io/writing/seldon-core/docker/2020/07/30/first-seldon-core-microservice.html","headline":"Build a Seldon-core Microservice","datePublished":"2020-07-30T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/writing/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://ntorba.github.io/writing/feed.xml" title="Turbo" /><link rel="shortcut icon" type="image/x-icon" href="/writing/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Build a Seldon-core Microservice | Turbo</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Build a Seldon-core Microservice" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Get an ML endpoint up and running!" />
<meta property="og:description" content="Get an ML endpoint up and running!" />
<link rel="canonical" href="https://ntorba.github.io/writing/seldon-core/docker/2020/07/30/first-seldon-core-microservice.html" />
<meta property="og:url" content="https://ntorba.github.io/writing/seldon-core/docker/2020/07/30/first-seldon-core-microservice.html" />
<meta property="og:site_name" content="Turbo" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-30T00:00:00-05:00" />
<script type="application/ld+json">
{"dateModified":"2020-07-30T00:00:00-05:00","description":"Get an ML endpoint up and running!","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ntorba.github.io/writing/seldon-core/docker/2020/07/30/first-seldon-core-microservice.html"},"url":"https://ntorba.github.io/writing/seldon-core/docker/2020/07/30/first-seldon-core-microservice.html","headline":"Build a Seldon-core Microservice","datePublished":"2020-07-30T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://ntorba.github.io/writing/feed.xml" title="Turbo" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    // remove paragraph tags in rendered toc (happens from notebooks)
    var toctags = document.querySelectorAll(".toc-entry")
    toctags.forEach(e => (e.firstElementChild.innerText = e.firstElementChild.innerText.replace('¶', '')))
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/writing/">Turbo</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/writing/about/">About</a><a class="page-link" href="/writing/search/">Search</a><a class="page-link" href="/writing/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Build a Seldon-core Microservice</h1><p class="page-description">Get an ML endpoint up and running!</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-07-30T00:00:00-05:00" itemprop="datePublished">
        Jul 30, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/writing/categories/#seldon-core">seldon-core</a>
        &nbsp;
      
        <a class="category-tags-link" href="/writing/categories/#docker">docker</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">
<a href="https://github.com/ntorba/writing/tree/master/_notebooks/2020-07-30-first-seldon-core-microservice.ipynb" role="button">
    <img class="notebook-badge-image" src="/writing/assets/badges/github.svg" alt="View On GitHub">
</a>
</div><div class="px-2">
    <a href="https://colab.research.google.com/github/ntorba/writing/blob/master/_notebooks/2020-07-30-first-seldon-core-microservice.ipynb">
        <img class="notebook-badge-image" src="/writing/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h3"><a href="#Reqs">Reqs </a></li>
<li class="toc-entry toc-h3"><a href="#Goal">Goal </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Steps">Steps </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Define-Python-Component">Define Python Component </a></li>
<li class="toc-entry toc-h3"><a href="#Build-Docker-Image">Build Docker Image </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Write-requirements.txt">Write requirements.txt </a></li>
<li class="toc-entry toc-h4"><a href="#Define-Dockerfile">Define Dockerfile </a></li>
<li class="toc-entry toc-h4"><a href="#Docker-Build">Docker Build </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Test-Image">Test Image </a></li>
<li class="toc-entry toc-h3"><a href="#STOP-HERE">STOP HERE </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-07-30-first-seldon-core-microservice.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Reqs">
<a class="anchor" href="#Reqs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reqs<a class="anchor-link" href="#Reqs"> </a>
</h3>
<ol>
<li>docker<ul>
<li>To complete this tutorial, you must have docker installed and be able to run containers from the command line. </li>
<li>Run <code>docker help</code> at the command line. If this outputs the docker help menu, you are ready to follow along! </li>
</ul>
</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Goal">
<a class="anchor" href="#Goal" aria-hidden="true"><span class="octicon octicon-link"></span></a>Goal<a class="anchor-link" href="#Goal"> </a>
</h3>
<ul>
<li>Prepare a docker image with seldon-core for deployment on kubernetes</li>
</ul>
<h4 id="Steps">
<a class="anchor" href="#Steps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Steps<a class="anchor-link" href="#Steps"> </a>
</h4>
<ol>
<li>Define a seldon python component</li>
<li>Build docker image</li>
<li>Run a container to test code</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Define-Python-Component">
<a class="anchor" href="#Define-Python-Component" aria-hidden="true"><span class="octicon octicon-link"></span></a>Define Python Component<a class="anchor-link" href="#Define-Python-Component"> </a>
</h3>
<p>I'm taking this example code directly from <a href="https://github.com/SeldonIO/seldon-core/blob/master/examples/models/sklearn_iris/sklearn_iris.ipynb">seldon-core irisClassifier example</a>. 
This code is used to train the model that will be served in the seldon-core microservice.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#hide_output</span>
<span class="o">!</span>mkdir iris_classifier
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse_show</span>
<span class="c1">#hide_output</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">datasets</span>


<span class="n">OUTPUT_FILE</span> <span class="o">=</span> <span class="s2">"iris_classifier/IrisClassifier.sav"</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">"Loading iris data set..."</span><span class="p">)</span>
<span class="n">iris</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_iris</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Dataset loaded!"</span><span class="p">)</span>

<span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s2">"liblinear"</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s2">"ovr"</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s2">"clf"</span><span class="p">,</span> <span class="n">clf</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Training model..."</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Model trained!"</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Saving model in </span><span class="si">{</span><span class="n">OUTPUT_FILE</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">OUTPUT_FILE</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Model saved!"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Loading iris data set...
Dataset loaded!
Training model...
Model trained!
Saving model in iris_classifier/IrisClassifier.sav
Model saved!
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we define the seldon python component that will be used to serve the model. 
Seldon has a few <a href="https://docs.seldon.io/projects/seldon-core/en/v1.1.0/python/python_component.html">components</a>. In this example, we only use the Model component. Seldon components hold the logic that will be implanted into the serving endpoint that seldon creates. The model component must have a predict function, which is called when the future endpoint is hit. 
The reason seldon is so useful is because this is the only python code we need to write to serve this model. Seldon provides the rest of the logic, which puts this component into a web server, to serve the model.</p>
<p>An important note about this section is that you'lll see the file is named <code>IrisClassifier.py</code>, which is camelcased. This is important, and you should not change this. The file name and the python component class name <strong>must match</strong>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> iris_classifier/IrisClassifier.py
<span class="c1">#collapse_show</span>
<span class="c1">#hide_output</span>
<span class="kn">import</span> <span class="nn">joblib</span>

<span class="k">class</span> <span class="nc">IrisClassifier</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'IrisClassifier.sav'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">features_names</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting iris_classifier/IrisClassifier.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Build-Docker-Image">
<a class="anchor" href="#Build-Docker-Image" aria-hidden="true"><span class="octicon octicon-link"></span></a>Build Docker Image<a class="anchor-link" href="#Build-Docker-Image"> </a>
</h3>
<p>After defining a python component, there are two ways to create the docker image necessary for deployment.</p>
<ul>
<li>
<a href="https://docs.seldon.io/projects/seldon-core/en/v1.1.0/python/python_wrapping_docker.html">define a Dockerfile</a> which launches the seldon microservice</li>
<li>use <a href="https://docs.seldon.io/projects/seldon-core/en/v1.1.0/wrappers/s2i.html">s2i</a> to build the image directly from source code. </li>
</ul>
<p>I prefer manually defining a Dockerfile because it provides more control over the process. However, s2i is a great tool that works just as well.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Write-requirements.txt">
<a class="anchor" href="#Write-requirements.txt" aria-hidden="true"><span class="octicon octicon-link"></span></a>Write requirements.txt<a class="anchor-link" href="#Write-requirements.txt"> </a>
</h4>
<p>We must write a requirements.txt library with all requirements for the docker image listed.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> iris_classifier/requirements.txt
<span class="c1">#hide_output</span>
<span class="n">sklearn</span>
<span class="n">seldon</span><span class="o">-</span><span class="n">core</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Define-Dockerfile">
<a class="anchor" href="#Define-Dockerfile" aria-hidden="true"><span class="octicon octicon-link"></span></a>Define Dockerfile<a class="anchor-link" href="#Define-Dockerfile"> </a>
</h4>
<p>The Dockerfile follows the example provided <a href="https://docs.seldon.io/projects/seldon-core/en/v1.1.0/python/python_wrapping_docker.html">here</a>. 
We start from the python:3.7-slim base image, copy the code from the current directory, which includes the python component we defined earlier, install requirements, then expose port 5000 for the microservice to run. 
Next, we define seldon specific variables.</p>
<ul>
<li>MODEL_NAME must match the python file name (which also much match the python component class name). </li>
<li>API_TYPE can be either REST or GRPC.</li>
<li>SERVICE_TYPE is the type of seldon component. MODEL for this example. (explore the other seldon components <a href="">here</a>
</li>
<li>PERSISTENCE: 0 or 1. Defaults to 0. If it is set to 1, the component class will be periodically persisted to reis. This s unnecessary for our case because the component class will not change.<ul>
<li>this would be more pertinent for components like routers, which can have updating states for long running jobs. </li>
</ul>
</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> iris_classifier/Dockerfile
<span class="c1">#collapse_show</span>
<span class="c1">#hide_output</span>
<span class="n">FROM</span> <span class="n">python</span><span class="p">:</span><span class="mf">3.7</span><span class="o">-</span><span class="n">slim</span>
<span class="n">COPY</span> <span class="o">.</span> <span class="o">/</span><span class="n">app</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">app</span>
<span class="n">RUN</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
<span class="n">EXPOSE</span> <span class="mi">5000</span>

<span class="c1"># Define environment variable</span>
<span class="n">ENV</span> <span class="n">MODEL_NAME</span> <span class="n">IrisClassifier</span> 
<span class="n">ENV</span> <span class="n">API_TYPE</span> <span class="n">REST</span>
<span class="n">ENV</span> <span class="n">SERVICE_TYPE</span> <span class="n">MODEL</span> 
<span class="n">ENV</span> <span class="n">PERSISTENCE</span> <span class="mi">0</span>

<span class="c1"># seldon-core-microservice is a command line tool installed with the seldon-core python libray. You can use this locally as well!</span>
<span class="n">CMD</span> <span class="n">exec</span> <span class="n">seldon</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="n">microservice</span> <span class="err">$</span><span class="n">MODEL_NAME</span> <span class="err">$</span><span class="n">API_TYPE</span> <span class="o">--</span><span class="n">service</span><span class="o">-</span><span class="nb">type</span> <span class="err">$</span><span class="n">SERVICE_TYPE</span> <span class="o">--</span><span class="n">persistence</span> <span class="err">$</span><span class="n">PERSISTENCE</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting iris_classifier/Dockerfile
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To test this example, let's build and run the docker image!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Docker-Build">
<a class="anchor" href="#Docker-Build" aria-hidden="true"><span class="octicon octicon-link"></span></a>Docker Build<a class="anchor-link" href="#Docker-Build"> </a>
</h4>
<p>Pass the iris_classifier dir where the image guts live, then pass a -t to tag the image with a name referring to your preferred docker image repository (I'm running on locally).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#hide_output</span>
<span class="o">!</span>docker build iris_classifier/ -t localhost:5000/iris_ex:latest
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-Image">
<a class="anchor" href="#Test-Image" aria-hidden="true"><span class="octicon octicon-link"></span></a>Test Image<a class="anchor-link" href="#Test-Image"> </a>
</h3>
<p>You can test your newly created image by running the image and hitting the endpoint. 
You may ask yourself at this point, "if I have a working docker image, what do I need kubernetes for?" 
This is a great question. For simple use cases, this docker image itself is all you need, and you could run it as a standalone service. If the load is small and you can run it without any load balancing functionalities, you are good to go. 
However, kubernetes is a container orchestration engine. That means it is built to handle complex containerized applications and will make your life much easier if you need to handle more complex operations for applications that need to serve on a large scale.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#hide_output</span>
<span class="o">!</span>docker run --name <span class="s2">"iris_predictor"</span> -d --rm -p <span class="m">5001</span>:5000 localhost:5000/iris_ex:latest
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You could also remove the -d argument from the above command and run this command in a separate window to see the log output while sending requests to the endpoint. Test the endpoint with the curl below!</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">grpc</span> 
<span class="kn">from</span> <span class="nn">seldon_core.proto</span> <span class="kn">import</span> <span class="n">prediction_pb2</span>
<span class="kn">from</span> <span class="nn">seldon_core.proto</span> <span class="kn">import</span> <span class="n">prediction_pb2_grpc</span>

<span class="c1">### Test Rest Endpoint</span>
<span class="o">!</span>curl -s http://localhost:5001/predict -H <span class="s2">"Content-Type: application/json"</span> -d <span class="s1">'{"data":{"ndarray":[[5.964,4.006,2.081,1.031]]}}'</span>


<span class="c1">### Test GRPC Endpoint</span>
<span class="c1"># data = np.array([[5.964,4.006,2.081,1.031]])</span>

<span class="c1"># datadef = prediction_pb2.DefaultData(</span>
<span class="c1">#     tensor=prediction_pb2.Tensor(shape=data.shape, values=data.flatten())</span>
<span class="c1"># )</span>
<span class="c1"># request = prediction_pb2.SeldonMessage(data=datadef)</span>
<span class="c1"># with grpc.insecure_channel("localhost:5001") as channel:</span>
<span class="c1">#     stub = prediction_pb2_grpc.ModelStub(channel)</span>
<span class="c1">#     response = stub.Predict(request=request)</span>
<span class="c1"># print(response)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{"data":{"names":[],"ndarray":[0.9481017681926894]},"meta":{}}
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you see successful output, you have your first seldon-core microservice up and running, congrats! 
Use the next command to stop the running docker container:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>docker container rm iris_predictor --force
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you are like me, you are a bit surprised at just how easy it was to create this. That is the power of seldon.</p>
<p>You may be wondering, what about kubernetes? Didn't your first post in this series say that you must have access to a cluster? That is still correct, and you will need that cluster in the following posts. I just like to start with this piece because it is straightforward and a rewarding way to start.</p>
<p>At this stage you are prepared to move onto any of these posts:</p>
<ul>
<li>
<a href="">Deploy First Microservice</a><ul>
<li>This post is for those excited to deploy your new docker image on kubernetes! </li>
</ul>
</li>
<li>
<a href="">Build Various Seldon-core microservices</a><ul>
<li>This post is for those more interested in learning about the other seldon components beside models</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="STOP-HERE">
<a class="anchor" href="#STOP-HERE" aria-hidden="true"><span class="octicon octicon-link"></span></a>STOP HERE<a class="anchor-link" href="#STOP-HERE"> </a>
</h3>
<ul>
<li>Once the docker image is created, I will create a new post that is specific to launching on kubernetes</li>
<li>Getting a working docker image is half the battle, and this can be a big success for users<ul>
<li>this is also a great jumping off point to instead say, want to make a more complex inference graph before kubernetes? or want to go learn about other python components before moving on to kubernetes?</li>
</ul>
</li>
<li>1) building docker, 2) launch on kubernetes<ul>
<li>in the light of mouldarity, I am better off keeping these steps separate from each other so users can focus on the docker and seldon stuff if they like</li>
<li>this has the other advantage that if users struggle with getting a local k8s cluster up, they can still leaving the tutorials feelings they have gained a good understanding of seldon because they have their nice docker images they built</li>
</ul>
</li>
</ul>
<p>First, let's take down the running docker container:</p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ntorba/writing"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/writing/seldon-core/docker/2020/07/30/first-seldon-core-microservice.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/writing/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/writing/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/writing/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Imma write some things here</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/ntorba" title="ntorba"><svg class="svg-icon grey"><use xlink:href="/writing/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/nicktorba" title="nicktorba"><svg class="svg-icon grey"><use xlink:href="/writing/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
